### `LocalPredicted`의 상세 실행 순서

이 과정을 이해하는 것은 GAS(Gameplay Ability System)의 네트워크 처리를 이해하는 데 매우 중요합니다. 아래 순서대로 진행됩니다.

1.  **입력 및 로컬 실행 (클라이언트)**

      * 플레이어가 키를 누르면, 소유한 클라이언트(owning client)는 즉시 `TryActivateAbility`를 호출합니다.
      * GAS는 어빌리티의 `NetExecutionPolicy`가 `LocalPredicted`인 것을 확인하고, **서버의 응답을 기다리지 않고 바로** 어빌리티의 `ActivateAbility`를 실행합니다.
      * 이때 클라이언트는 '예측 키(Prediction Key)'라는 고유한 ID를 생성하여 이 예측 실행을 식별합니다. 이 키는 나중에 서버의 결과와 동기화하는 데 사용됩니다.
      * 플레이어의 화면에는 즉각적인 반응이 나타납니다. (예: 총알이 발사되는 이펙트, 캐릭터가 스킬 모션을 취하는 모습)

2.  **서버에 실행 요청 (클라이언트 → 서버)**

      * 로컬에서 어빌리티를 실행함과 동시에, 클라이언트는 서버에게 "나 이 어빌리티를 사용하려고 해"라는 RPC(Remote Procedure Call)를 보냅니다. 이때 앞서 생성한 **예측 키**를 함께 전달합니다.

3.  **권위있는 실행 (서버)**

      * 서버는 클라이언트로부터 받은 RPC를 통해 어빌리티 실행 요청을 받습니다.
      * 서버는 이 어빌리티를 실행할 **모든 조건이 충족되는지** (쿨타임, 자원 소모, 다른 상태 이상 등) **권위적으로(authoritatively) 검증**합니다.
      * 검증을 통과하면, 서버는 어빌리티의 `ActivateAbility`를 실행합니다. 이 실행이 게임 월드의 '진짜' 상태를 변경합니다.
      * 서버는 클라이언트가 보낸 예측 키를 가지고 이 실행을 기록합니다.

4.  **결과 전파 및 클라이언트의 예측 수정 (서버 → 클라이언트)**

      * 서버에서의 어빌리티 실행 결과(예: 체력 감소, 버프 적용, 게임플레이 이펙트 발생)는 리플리케이션(Replication)을 통해 모든 클라이언트에게 전파됩니다.
      * 어빌리티를 예측 실행했던 원래의 클라이언트는 서버로부터 이 '공식적인' 결과를 받습니다.
      * **예측 성공**: 클라이언트가 예측했던 결과와 서버의 공식 결과가 일치하면, 예측 키 시스템에 의해 자연스럽게 동기화됩니다. 플레이어는 아무런 이상을 느끼지 못합니다.
      * **예측 실패**: 만약 서버가 어빌리티 실행을 거부했거나(예: 쿨타임이 아직 안 됐음), 결과가 달랐다면(예: 서버에서는 피격 판정이 나지 않음), 클라이언트는 서버의 상태에 맞춰 **자신의 상태를 강제로 수정**(Correction)해야 합니다. 이를 '롤백(Rollback)'이라고도 하며, 플레이어에게는 순간적으로 캐릭터나 이펙트가 원래 위치로 돌아가는 현상(랙처럼 보이는)으로 나타날 수 있습니다.

### 라이라(Lyra)에서의 관점

라이라 스타터 게임에서는 플레이어의 **즉각적인 반응성**이 중요한 거의 모든 어빌리티(발사, 대시, 스킬 사용 등)가 `LocalPredicted`로 설정되어 있습니다. 이는 AAA급 멀티플레이어 게임에서 부드럽고 쾌적한 플레이 경험을 제공하기 위한 표준적인 설계입니다.

서버가 모든 것을 결정하지만(Server-Authoritative), 플레이어에게는 마치 모든 것이 즉시 일어나는 것처럼 '예측'을 통해 보여주는 것입니다. 이 예측과 수정 메커니즘이 잘 동작해야만 훌륭한 네트워크 플레이 경험을 만들 수 있습니다.

아래는 일반적인 예측 어빌리티의 생성자 설정 예시입니다.

```cpp
UYourGameplayAbility::UYourGameplayAbility()
{
    // 어빌리티 인스턴스를 생성하여 상태를 유지하도록 설정합니다. 예측에 자주 사용됩니다.
    InstancingPolicy = EGameplayAbilityInstancingPolicy::InstancedPerActor;

    // 클라이언트가 먼저 예측 실행하고, 서버가 권위적으로 실행합니다.
    NetExecutionPolicy = EGameplayAbilityNetExecutionPolicy::LocalPredicted;

    // 클라이언트 또는 서버에서 활성화될 수 있음을 명시합니다.
    NetSecurityPolicy = EGameplayAbilityNetSecurityPolicy::ClientOrServer;
}
```

-----

### 요약

`NetExecutionPolicy`가 `LocalPredicted`일 때의 실행 주체와 역할을 표로 정리하면 다음과 같습니다.

| 단계 | 실행 주체 | 주요 역할 |
| :--- | :--- | :--- |
| **1. 예측 실행** | **클라이언트** | **가장 먼저 실행.** 즉각적인 시각적/게임플레이 피드백을 제공. |
| **2. 권위적 실행** | **서버** | 클라이언트의 요청을 받아 **검증 후 최종 실행.** 게임의 실제 상태를 결정. |
| **3. 상태 동기화** | **모든 클라이언트** | 서버의 실행 결과를 리플리케이션 받아 자신의 월드 상태를 업데이트. |
| **4. 예측 수정** | **원래 클라이언트** | 서버의 결과와 자신의 예측이 다를 경우, 서버의 상태에 맞춰 강제로 수정. |
